<policies>
  <inbound>
    <base />

    <!-- Correlation ID -->
    <set-variable name="correlationId" value="@(
        context.Request.Headers.ContainsKey("x-correlation-id") 
            ? context.Request.Headers.GetValueOrDefault("x-correlation-id","")
            : Guid.NewGuid().ToString()
    )" />
    <set-header name="x-correlation-id" exists-action="override">
      <value>@((string)context.Variables["correlationId"])</value>
    </set-header>

    <!-- CORS baseado em allowedOrigins -->
    <set-variable name="allowedOrigins" value="{{allowedOrigins}}" />
    <choose>
      <when condition="@(context.Request.Headers.ContainsKey("Origin"))">
        <set-variable name="requestOrigin" value="@(context.Request.Headers.GetValueOrDefault("Origin",""))" />
        <choose>
          <when condition="@(((string)context.Variables["allowedOrigins"])
                                .Split(',')
                                .Select(o => o.Trim())
                                .Contains((string)context.Variables["requestOrigin"]))">
            <set-header name="Access-Control-Allow-Origin" exists-action="override">
              <value>@((string)context.Variables["requestOrigin"])</value>
            </set-header>
            <set-header name="Access-Control-Allow-Methods" exists-action="override">
              <value>GET, POST, PUT, PATCH, DELETE, OPTIONS</value>
            </set-header>
            <set-header name="Access-Control-Allow-Headers" exists-action="override">
              <value>*</value>
            </set-header>
            <set-header name="Access-Control-Expose-Headers" exists-action="override">
              <value>x-correlation-id, x-bff-proxy</value>
            </set-header>
            <set-header name="Access-Control-Max-Age" exists-action="override">
              <value>300</value>
            </set-header>
          </when>
        </choose>
      </when>
    </choose>

    <!-- Pré-flight OPTIONS -->
    <choose>
      <when condition="@(context.Request.Method == "OPTIONS")">
        <return-response>
          <set-status code="204" reason="No Content" />
        </return-response>
      </when>
    </choose>

    <!-- Rate limit por IP (policy válida) -->
    <rate-limit-by-key 
      calls="{{rateLimitCalls}}" 
      renewal-period="{{rateLimitRenewalPeriod}}"
      counter-key="@{
        var forwardedFor = context.Request.Headers.GetValueOrDefault("X-Forwarded-For", "");
        return string.IsNullOrEmpty(forwardedFor) 
          ? context.Request.IpAddress 
          : forwardedFor.Split(',')[0].Trim();
      }" />

    <!-- Forward de headers -->
    <set-header name="Authorization" exists-action="override">
      <value>@(context.Request.Headers.GetValueOrDefault("Authorization", ""))</value>
    </set-header>

    <set-header name="x-forwarded-host" exists-action="override">
      <value>@(context.Request.OriginalUrl.Host)</value>
    </set-header>

    <set-header name="x-forwarded-proto" exists-action="override">
      <value>@(context.Request.OriginalUrl.Scheme)</value>
    </set-header>

    <set-header name="x-real-ip" exists-action="override">
      <value>@(context.Request.IpAddress)</value>
    </set-header>

    <!-- Backend: sempre o BFF -->
    <set-backend-service base-url="{{bffBackendUrl}}" />
  </inbound>

  <backend>
    <base />
  </backend>

  <outbound>
    <base />

    <!-- Marca que passou pelo gateway -->
    <set-header name="x-bff-proxy" exists-action="override">
      <value>true</value>
    </set-header>

    <!-- Garante correlation-id na resposta -->
    <set-header name="x-correlation-id" exists-action="override">
      <value>@((string)context.Variables["correlationId"])</value>
    </set-header>

    <!-- Remove headers sensíveis -->
    <set-header name="X-AspNet-Version" exists-action="delete" />
    <set-header name="X-Powered-By" exists-action="delete" />
    <set-header name="Server" exists-action="delete" />
  </outbound>

  <on-error>
    <base />

    <set-header name="Content-Type" exists-action="override">
      <value>application/json</value>
    </set-header>

    <set-header name="x-correlation-id" exists-action="override">
      <value>@{
        var cid = context.Variables.GetValueOrDefault<string>("correlationId", "");
        return string.IsNullOrEmpty(cid) ? Guid.NewGuid().ToString() : cid;
      }</value>
    </set-header>

    <set-body>@{
      var statusCode = context.Response.StatusCode;
      var correlationId = context.Variables.GetValueOrDefault<string>("correlationId", Guid.NewGuid().ToString());
      var message = context.LastError?.Message ?? "An error occurred while processing your request";
      var errorType = "gateway_error";

      if (statusCode == 429) { errorType = "rate_limit_exceeded"; }
      else if (statusCode == 404) { errorType = "not_found"; }
      else if (statusCode == 401) { errorType = "unauthorized"; }
      else if (statusCode == 403) { errorType = "forbidden"; }
      else if (statusCode >= 500) { errorType = "server_error"; }
      else if (statusCode >= 400) { errorType = "client_error"; }

      // escapa aspas na mensagem pra não quebrar JSON
      var safeMessage = message.Replace("\"", "\\\"");

      var json = string.Format(
        "{{\"error\":\"{0}\",\"message\":\"{1}\",\"statusCode\":{2},\"correlationId\":\"{3}\",\"timestamp\":\"{4:O}\"}}",
        errorType,
        safeMessage,
        statusCode,
        correlationId,
        DateTime.UtcNow
      );

      return json;
    }</set-body>
  </on-error>
</policies>
